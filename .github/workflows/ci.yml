name: ci

on:
  push:
    branches: [ main ]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests-api:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip (API)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-api-${{ runner.os }}-${{ hashFiles('API/requirements_dev.txt') }}

      - name: Install dev deps (API)
        working-directory: API
        run: pip install -r requirements_dev.txt

  tests-client-e2e:
    needs: tests-api
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip (API)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-api-${{ runner.os }}-${{ hashFiles('API/requirements_dev.txt') }}

      - name: Cache pip (client)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-client-${{ runner.os }}-${{ hashFiles('client/requirements_client.txt') }}

      # --- ÉTAPES SIMPLIFIÉES ---
      
      - name: Install all dependencies (API + Client + Tests)
        run: |
          pip install -r API/requirements_dev.txt
          pip install -r client/requirements_client.txt
          pip install -U pytest pytest-playwright playwright

      - name: Install Playwright browsers
        run: python -m playwright install --with-deps chromium

      - name: Run E2E tests
        env:
          PYTHONPATH: ${{ github.workspace }}
          API_STATIC_KEY: ${{ secrets.API_STATIC_KEY }}
          JWT_SECRET:  ${{ secrets.JWT_SECRET }}
          E2E_STARTUP_TIMEOUT: "120"
          E2E: "1"
          DATABASE_URL: "postgresql+psycopg2://testuser:testpassword@127.0.0.1:5432/testdb"
        run: pytest -q client/tests/test_streamlit.py

      - name: Upload screenshot on failure
        if: failure() # Ne s'exécute que si l'étape précédente a échoué
        uses: actions/upload-artifact@v4
        with:
          name: screenshot-on-failure
          path: client/test-results/ 

  build-and-push:
    needs: [tests-api, tests-client-e2e]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --- Build & push API image ---
      - name: Build & push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./API/Dockerfile
          target: prod
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-api:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-api:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/restaurant-api:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/restaurant-api:buildcache,mode=max

      # --- Build & push Streamlit client image ---
      - name: Build & push Client (Streamlit) image
        uses: docker/build-push-action@v6
        with:
          context: ./client
          file: ./client/streamlit.Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-client:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-client:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/restaurant-client:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/restaurant-client:buildcache,mode=max
